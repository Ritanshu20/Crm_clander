{% extends 'base.html' %}

{% block title %}Calendar - CRM Event Calendar{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">
<style>
    #calendar {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .fc-event {
        cursor: pointer;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-calendar3"></i> Calendar View</h2>
        <p class="text-muted">View and manage all your events in calendar format.</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">Event Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- Event details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" id="eventModalEdit" class="btn btn-primary">Edit Event</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: '{% url "events_json" %}',
            eventClick: function(info) {
                // Show event details in modal
                const event = info.event;
                const eventId = event.id;
                
                // Fetch event details
                fetch(`/event/${eventId}/`)
                    .then(response => response.text())
                    .then(html => {
                        // Create a temporary div to parse the HTML
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        
                        // Extract event details from the page
                        const eventDetail = tempDiv.querySelector('.event-details');
                        if (eventDetail) {
                            document.getElementById('eventModalBody').innerHTML = eventDetail.innerHTML;
                        } else {
                            document.getElementById('eventModalBody').innerHTML = html;
                        }
                        
                        // Set edit link
                        document.getElementById('eventModalEdit').href = `/event/${eventId}/update/`;
                        
                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('eventModal'));
                        modal.show();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        // Fallback: redirect to event detail page
                        window.location.href = `/event/${eventId}/`;
                    });
            },
            eventDisplay: 'block',
            height: 'auto',
            nowIndicator: true,
            dayMaxEvents: true,
        });
        
        calendar.render();
    });
</script>
{% endblock %}

